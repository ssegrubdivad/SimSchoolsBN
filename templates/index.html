<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Bayesian Network API</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
        }
        body {
            font-family: -apple-system,system-ui,"Segoe UI",Helvetica,Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji";
            font-weight: 100;
            color: black;
            background-color: white;
            padding: 5vh 15vw;
            box-sizing: border-box;
            overflow-y: auto;
        }
        .headline {
            border: #3492eb 0.35vmin solid;
            border-radius: 2vmin;
            padding: 2vmin 3vmin 3vmin 3vmin;
            text-align: center;
            font-size: 6vmin;
            box-shadow: rgba(17, 17, 26, 0.05) 0px 1px 0px, rgba(17, 17, 26, 0.1) 0px 0px 8px;
        }
        .heavy {
            font-weight: 600;
        }
        .info {
            border: #3492eb 0.35vmin solid;
            border-radius: 2vmin;
            padding: 2vmin 3vmin 3vmin 3vmin;
            width: 100%;
            margin-bottom: 2vh;
            box-sizing: border-box;
        }
        input, button {
            margin: 0 0 2vh 0;
            font-family: 'Courier New', monospace;
            font-weight: 600;
            font-size: 1.5vmin;
            color: white;
            background-color: #2b2b28;
        }
        .title {
            font-weight: 800;
            font-size: 4vmin;
            padding-bottom: 3vmin;
            padding-left: 1vmin;
            display: inline-block;
        }
        #token {
            max-width: 100%;
            width: 100%;
            height: 10vmin;
            font-family: 'Courier New', monospace;
            max-height: 20vmin;
            font-size: 1.5vmin;
            background-color: #2b2b28;
            color: white;
        }
    </style>
</head>
<body>
    <div class="content-wrapper">
        <div class="title">Welcome to the Bayesian Network API</div><br />
        
        <div class="debug-box">
            <p>Debug Info: If you can see this box, the content is being rendered correctly.</p>
            <p>Viewport Height: <span id="viewport-height"></span></p>
            <p>Document Height: <span id="document-height"></span></p>
        </div>

        <form id="loginForm" onsubmit="login(event)">
            <div class="info">
                <h2>Login</h2>
                <input type="text" id="username" placeholder="Username" required /><br />
                <input type="password" id="password" placeholder="Password" required /><br />
                <button type="submit">Login</button>
            </div>
        </form>
        
        <div id="apiInfo" style="display: none;">
            <div class="info">
                <h2>API Endpoints</h2>
                <p>Use the following endpoints:</p>
                <ul>
                    <li><code>/upload_network</code> (POST): Upload a new Bayesian Network</li>
                    <li><code>/upload_cpt</code> (POST): Upload a CPT file</li>
                    <li><code>/query</code> (POST): Query the Bayesian Network</li>
                </ul>
                <p>Token:<br /><textarea id="token"></textarea></p>
            </div>
            
            <div class="info">
                <h2>Upload Bayesian Network</h2>
                <form id="uploadNetworkForm">
                    <input type="file" id="networkFile" accept=".bns" required />
                    <button type="submit">Upload Network</button>
                </form>
            </div>
            
            <div class="info">
                <h2>Upload CPT</h2>
                <form id="uploadCPTForm">
                    <input type="file" id="cptFile" accept=".cpt" required />
                    <button type="submit">Upload CPT</button>
                </form>
            </div>
            <div class="info">
                <h2>Visualize Network</h2>
                <button id="visualizeNetworkBtn" onclick="visualizeNetwork()">Visualize Network</button>
                <div id="networkVisualization"></div>
            </div>
        </div>

        <div class="debug-box">
            <p>Debug Info: If you can see this box, all content has been loaded.</p>
        </div>
    </div>

    <script>
        let apiToken = '';
        const apiBaseUrl = ''; // Use relative URL

        // Debug info update
        function updateDebugInfo() {
            document.getElementById('viewport-height').textContent = window.innerHeight + 'px';
            document.getElementById('document-height').textContent = document.documentElement.scrollHeight + 'px';
        }

        window.addEventListener('load', updateDebugInfo);
        window.addEventListener('resize', updateDebugInfo);

        async function login(event) {
            event.preventDefault(); // Prevent default form submission
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            try {
                const response = await axios.post('/login', { username, password });
                apiToken = response.data.token;
                document.getElementById('token').textContent = apiToken;
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('apiInfo').style.display = 'block';
                updateDebugInfo(); // Update debug info after showing new content
            } catch (error) {
                alert('Login failed');
                console.error('Login error:', error);
            }
        }

        async function uploadNetwork(event) {
            event.preventDefault();
            const fileInput = document.getElementById('networkFile');
            const file = fileInput.files[0];
            if (!file) {
                alert('Please select a file');
                return;
            }
            const formData = new FormData();
            formData.append('file', file);
            try {
                const response = await axios.post('/upload_network', formData, {
                    headers: { 
                        'Authorization': 'Bearer ' + apiToken,
                        'Content-Type': 'multipart/form-data'
                    }
                });
                console.log(response.data);
                alert('Network uploaded successfully');
            } catch (error) {
                console.error('Error uploading network:', error);
                alert('Error uploading network');
            }
        }

        async function uploadCPT(event) {
            event.preventDefault();
            const fileInput = document.getElementById('cptFile');
            const file = fileInput.files[0];
            if (!file) {
                alert('Please select a file');
                return;
            }
            const formData = new FormData();
            formData.append('file', file);
            try {
                const response = await axios.post('/upload_cpt', formData, {
                    headers: { 
                        'Authorization': 'Bearer ' + apiToken,
                        'Content-Type': 'multipart/form-data'
                    }
                });
                console.log(response.data);
                alert('CPT uploaded successfully');
            } catch (error) {
                console.error('Error uploading CPT:', error);
                alert('Error uploading CPT');
            }
        }

        async function queryNetwork(queryData) {
            try {
                const response = await axios.post('/query', queryData, {
                    headers: { 'Authorization': 'Bearer ' + apiToken }
                });
                console.log(response.data);
            } catch (error) {
                console.error('Error querying network:', error);
            }
        }

        document.getElementById('uploadNetworkForm').addEventListener('submit', uploadNetwork);
        document.getElementById('uploadCPTForm').addEventListener('submit', uploadCPT);

        async function visualizeNetwork() {
            try {
                const response = await axios.get('/visualize_network', {
                    headers: { 'Authorization': 'Bearer ' + apiToken },
                    responseType: 'text'
                });
                document.getElementById('networkVisualization').innerHTML = response.data;
            } catch (error) {
                console.error('Error visualizing network:', error);
                alert('Error visualizing network');
            }
        }
    </script>
</body>
</html>