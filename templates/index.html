<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Bayesian Network API</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
        }
        body {
            font-family: -apple-system,system-ui,"Segoe UI",Helvetica,Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji";
            font-weight: 100;
            color: black;
            background-color: white;
            padding: 5vh 15vw;
            box-sizing: border-box;
            overflow-y: auto;
        }
        .headline {
            border: #3492eb 0.35vmin solid;
            border-radius: 2vmin;
            padding: 2vmin 3vmin 3vmin 3vmin;
            text-align: center;
            font-size: 6vmin;
            box-shadow: rgba(17, 17, 26, 0.05) 0px 1px 0px, rgba(17, 17, 26, 0.1) 0px 0px 8px;
        }
        .heavy {
            font-weight: 600;
        }
        .info {
            border: #3492eb 0.35vmin solid;
            border-radius: 2vmin;
            padding: 2vmin 3vmin 3vmin 3vmin;
            width: 100%;
            margin-bottom: 2vh;
            box-sizing: border-box;
        }
        input, button {
            margin: 0 0 2vh 0;
            font-family: 'Courier New', monospace;
            font-weight: 600;
            font-size: 1.5vmin;
            color: white;
            background-color: #2b2b28;
        }
        .title {
            font-weight: 800;
            font-size: 4vmin;
            padding-bottom: 3vmin;
            padding-left: 1vmin;
            display: inline-block;
        }
        #token {
            max-width: 100%;
            width: 100%;
            height: 10vmin;
            font-family: 'Courier New', monospace;
            max-height: 20vmin;
            font-size: 1.5vmin;
            background-color: #2b2b28;
            color: white;
        }

/*        For the networkVisualization svg element*/
        .links line {
            stroke: #999;
            stroke-opacity: 0.6;
        }
        .nodes circle {
            stroke: #fff;
            stroke-width: 1.5px;
        }
        text {
            font-family: sans-serif;
            font-size: 12px;
        }
        #networkVisualization {
            border: 1px solid #ccc;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="content-wrapper">
        <div class="title">Welcome to the Bayesian Network API</div><br />
        
        <div class="debug-box">
            <p>Debug Info: If you can see this box, the content is being rendered correctly.</p>
            <p>Viewport Height: <span id="viewport-height"></span></p>
            <p>Document Height: <span id="document-height"></span></p>
        </div>

        <form id="loginForm" onsubmit="login(event)">
            <div class="info">
                <h2>Login</h2>
                <input type="text" id="username" placeholder="Username" required /><br />
                <input type="password" id="password" placeholder="Password" required /><br />
                <button type="submit">Login</button>
            </div>
        </form>
        
        <div id="apiInfo" style="display: block;">
            <div class="info">
                <h2>API Endpoints</h2>
                <p>Use the following endpoints:</p>
                <ul>
                    <li><code>/upload_network</code> (POST): Upload a new Bayesian Network</li>
                    <li><code>/upload_cpt</code> (POST): Upload a CPT file</li>
                    <li><code>/query</code> (POST): Query the Bayesian Network</li>
                </ul>
                <p>Token:<br><textarea id="token"></textarea></p>
            </div>
            
            <div class="info">
                <h2>Upload Bayesian Network</h2>
                <form id="uploadNetworkForm">
                    <input type="file" id="networkFile" accept=".bns" required="">
                    <button type="submit">Upload Network</button>
                </form>
            </div>
            
            <div class="info">
                <h2>Upload CPT</h2>
                <form id="uploadCPTForm">
                    <input type="file" id="cptFile" accept=".cpt" required="">
                    <button type="submit">Upload CPT</button>
                </form>
            </div>

            <div class="info">
                <h2>Visualize Network</h2>
                <button id="visualizeNetworkBtn" onclick="visualizeNetwork()">Visualize Network</button>
                <div id="networkVisualization" style="width: 960px; height: 600px; border: 1px solid #ccc; margin-top: 10px;"></div>
            </div>
        </div>

    <script>
        let apiToken = '';
        const apiBaseUrl = ''; // Use relative URL

        // Debug info update
        function updateDebugInfo() {
            document.getElementById('viewport-height').textContent = window.innerHeight + 'px';
            document.getElementById('document-height').textContent = document.documentElement.scrollHeight + 'px';
        }

        window.addEventListener('load', updateDebugInfo);
        window.addEventListener('resize', updateDebugInfo);

        async function login(event) {
            event.preventDefault(); // Prevent default form submission
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            try {
                const response = await axios.post('/login', { username, password });
                apiToken = response.data.token;
                document.getElementById('token').textContent = apiToken;
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('apiInfo').style.display = 'block';
                updateDebugInfo(); // Update debug info after showing new content
            } catch (error) {
                alert('Login failed');
                console.error('Login error:', error);
            }
        }

        async function uploadNetwork(event) {
            event.preventDefault();
            const fileInput = document.getElementById('networkFile');
            const file = fileInput.files[0];
            if (!file) {
                alert('Please select a file');
                return;
            }
            const formData = new FormData();
            formData.append('file', file);
            try {
                const response = await axios.post('/upload_network', formData, {
                    headers: { 
                        'Authorization': 'Bearer ' + apiToken,
                        'Content-Type': 'multipart/form-data'
                    }
                });
                console.log(response.data);
                alert('Network uploaded successfully');
            } catch (error) {
                console.error('Error uploading network:', error);
                alert('Error uploading network');
            }
        }

        async function uploadCPT(event) {
            event.preventDefault();
            const fileInput = document.getElementById('cptFile');
            const file = fileInput.files[0];
            if (!file) {
                alert('Please select a file');
                return;
            }
            const formData = new FormData();
            formData.append('file', file);
            try {
                const response = await axios.post('/upload_cpt', formData, {
                    headers: { 
                        'Authorization': 'Bearer ' + apiToken,
                        'Content-Type': 'multipart/form-data'
                    }
                });
                console.log(response.data);
                alert('CPT uploaded successfully');
            } catch (error) {
                console.error('Error uploading CPT:', error);
                alert('Error uploading CPT');
            }
        }

        async function queryNetwork(queryData) {
            try {
                const response = await axios.post('/query', queryData, {
                    headers: { 'Authorization': 'Bearer ' + apiToken }
                });
                console.log(response.data);
            } catch (error) {
                console.error('Error querying network:', error);
            }
        }

        async function visualizeNetwork() {
            try {
                const response = await axios.get('/visualize_network', {
                    headers: { 'Authorization': 'Bearer ' + apiToken },
                    responseType: 'json'
                });
                
                const visualizationDiv = document.getElementById('networkVisualization');
                visualizationDiv.innerHTML = ''; // Clear previous content
                
                const svg = d3.select(visualizationDiv)
                    .append("svg")
                    .attr("width", visualizationDiv.clientWidth)
                    .attr("height", visualizationDiv.clientHeight);

                const graph = response.data;

                const color = d3.scaleOrdinal(d3.schemeCategory10);

                const simulation = d3.forceSimulation()
                    .force("link", d3.forceLink().id(d => d.id).distance(100))
                    .force("charge", d3.forceManyBody().strength(-300))
                    .force("center", d3.forceCenter(visualizationDiv.clientWidth / 2, visualizationDiv.clientHeight / 2));

                // Create arrow marker for directed edges
                svg.append("defs").selectAll("marker")
                    .data(["end"])
                    .enter().append("marker")
                    .attr("id", String)
                    .attr("viewBox", "0 -5 10 10")
                    .attr("refX", 15)
                    .attr("refY", -1.5)
                    .attr("markerWidth", 6)
                    .attr("markerHeight", 6)
                    .attr("orient", "auto")
                    .append("path")
                    .attr("d", "M0,-5L10,0L0,5");

                const link = svg.append("g")
                    .attr("class", "links")
                    .selectAll("line")
                    .data(graph.links)
                    .enter().append("line")
                    .attr("stroke-width", 2)
                    .attr("stroke", "#999")
                    .attr("marker-end", "url(#end)");  // Add arrow marker

                const node = svg.append("g")
                    .attr("class", "nodes")
                    .selectAll("g")
                    .data(graph.nodes)
                    .enter().append("g");

                const circles = node.append("circle")
                    .attr("r", 10)
                    .attr("fill", d => color(d.id));

                const labels = node.append("text")
                    .text(d => d.id)
                    .attr('x', 12)
                    .attr('y', 3);

                node.append("title")
                    .text(d => d.id);

                simulation
                    .nodes(graph.nodes)
                    .on("tick", ticked);

                simulation.force("link")
                    .links(graph.links);

                function ticked() {
                    link
                        .attr("x1", d => d.source.x)
                        .attr("y1", d => d.source.y)
                        .attr("x2", d => d.target.x)
                        .attr("y2", d => d.target.y);

                    node
                        .attr("transform", d => `translate(${d.x},${d.y})`);
                }

                // Add drag capabilities
                node.call(d3.drag()
                    .on("start", dragstarted)
                    .on("drag", dragged)
                    .on("end", dragended));

                // Drag functions
                function dragstarted(event, d) {
                    if (!event.active) simulation.alphaTarget(0.3).restart();
                    d.fx = d.x;
                    d.fy = d.y;
                }

                function dragged(event, d) {
                    d.fx = event.x;
                    d.fy = event.y;
                }

                function dragended(event, d) {
                    if (!event.active) simulation.alphaTarget(0);
                    d.fx = null;
                    d.fy = null;
                }
            } catch (error) {
                console.error('Error visualizing network:', error);
                alert('Error visualizing network');
            }
        }

        document.getElementById('uploadNetworkForm').addEventListener('submit', uploadNetwork);
        document.getElementById('uploadCPTForm').addEventListener('submit', uploadCPT);
    </script>
</body>
</html>